package com.project.advertisement.dao;

import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.List;
import java.util.UUID;

import javax.swing.text.StyledEditorKit.BoldAction;

import org.mindrot.jbcrypt.BCrypt;
import org.springframework.orm.hibernate5.support.HibernateDaoSupport;
import org.springframework.transaction.annotation.Transactional;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.project.advertisement.entity.Actions;
import com.project.advertisement.entity.Advertise;
import com.project.advertisement.entity.Category;
import com.project.advertisement.entity.User;
import com.project.advertisement.entity.UserSession;

public class UserDAOImpl extends HibernateDaoSupport  implements UserDAO {

	@Transactional
	public String createUser(User user) {
		List<User> checkIfUsernameExist=(List<User>)getHibernateTemplate().find("FROM User where USERNAME=?", user.getUserName());
		if(checkIfUsernameExist.size()>0){
			return "Username In Use";
		}
		else{
			user.setPassword(BCrypt.hashpw(user.getPassword(), BCrypt.gensalt(12)));
			System.out.println(BCrypt.hashpw(user.getPassword(), BCrypt.gensalt(12)));
			getHibernateTemplate().save(user);
			return "Registration successful";
		}
	}

	@Transactional
	public String login(String userName, String password) {
		List<UserSession> prevUserSession=(List<UserSession>)getHibernateTemplate().find("FROM UserSession WHERE userName=?", userName);
		
		if(!prevUserSession.isEmpty()){
			return prevUserSession.get(0).getAuthToken();
		}
		else{
			List<User> checkIfUsernameExist=(List<User>)getHibernateTemplate().find("FROM User where USERNAME=?", userName);
			if(checkIfUsernameExist.size()==0){
				return "Invalid Credential";
			}
			else{
				boolean password_verified = BCrypt.checkpw(password, checkIfUsernameExist.get(0).getPassword());
				if(password_verified)
				{
					String authToken=UUID.randomUUID().toString();
					UserSession userSession=new UserSession(authToken,userName);
					getHibernateTemplate().save(userSession);
					return authToken;
				}
				else{
					return "Invalid Credential";
				}
			}
		}
		
	}

	@Transactional
	public String logout(String auth_token) throws JsonProcessingException {
		List<UserSession> prevUserSession=(List<UserSession>)getHibernateTemplate().find("FROM UserSession WHERE authToken=?", auth_token);

		if(!prevUserSession.isEmpty()){
			getHibernateTemplate().delete(prevUserSession.get(0));
			return "Logout Successful";
		}
		else{
			return "Invalid Operation";
		}
	}
	
	public String getCategories() throws JsonProcessingException {
		List<Category> categoryList=(List<Category>)getHibernateTemplate().find("FROM Category");
		String str="";
		ObjectMapper mapper=new ObjectMapper();
		str=mapper.writeValueAsString(categoryList);
		return str;
	}

	public String getActions() throws JsonProcessingException {
		List<Actions> categoryList=(List<Actions>)getHibernateTemplate().find("FROM Actions");
		String str="";
		ObjectMapper mapper=new ObjectMapper();
		str=mapper.writeValueAsString(categoryList);
		return str;
	}

	

	public String postAd(Advertise ad, String auth_token) {
		List<UserSession> userSession=(List<UserSession>)getHibernateTemplate().find("FROM UserSession WHERE authToken=?", auth_token);
		if(!userSession.isEmpty())
		{
			Advertise userAd=new Advertise();
			userAd.setTitle(ad.getTitle());
			userAd.setCategory(ad.getCategory());
			userAd.setDescription(ad.getDescription());
			userAd.setName(ad.getName());
			getHibernateTemplate().save(userAd);
			return "Ad Posted!";
		}	
		else
		{	
			return "Invalid auth-token";
		}
	}

}
